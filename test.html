<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üöå Qu·∫£n l√Ω L·ªãch Tr√¨nh Tu·∫ßn</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif;}
body{background:#f5f7fa;padding:20px;}
.container{max-width:1100px;margin:auto;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);padding:20px;}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
h1{color:#2563eb;}
p{color:#6b7280;font-size:14px;}
.btn{padding:10px 16px;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:0.2s;}
.btn-primary{background:#2563eb;color:white;}
.btn-primary:hover{background:#1d4ed8;}
.btn-outline{background:white;color:#2563eb;border:1px solid #2563eb;}
.btn-outline:hover{background:#eff6ff;}
.week-nav{display:flex;justify-content:space-between;align-items:center;margin:15px 0;}
.card{background:white;border:1px solid #e5e7eb;border-radius:8px;padding:15px;margin-bottom:10px;}
.card h3{font-size:16px;color:#111827;margin-bottom:5px;}
.card small{color:#6b7280;}
.week-info{background:#eff6ff;border-left:4px solid #2563eb;padding:10px;border-radius:6px;margin-bottom:10px;}
dialog{border:none;border-radius:8px;width:480px;padding:20px;}
dialog::backdrop{background:rgba(0,0,0,0.4);}
.form-group{margin-bottom:15px;}
label{font-weight:600;display:block;margin-bottom:4px;}
select,input{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;}
.weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
.day{padding:6px;text-align:center;border:1px solid #ccc;border-radius:6px;cursor:pointer;}
.day.selected{background:#2563eb;color:white;}
.alert{padding:10px;background:#fff3cd;border-left:4px solid #facc15;border-radius:6px;margin-bottom:10px;}
.schedule-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e5e7eb;}
.schedule-item:last-child{border-bottom:none;}
.schedule-info{flex:1;}
.schedule-actions{display:flex;gap:8px;}
.btn-sm{padding:4px 8px;font-size:12px;}
.btn-danger{background:#dc2626;color:white;}
.btn-danger:hover{background:#b91c1c;}
.btn-success{background:#059669;color:white;}
.btn-success:hover{background:#047857;}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <h1>üöå Qu·∫£n l√Ω L·ªãch Tr√¨nh Tu·∫ßn</h1>
      <p>T·∫°o v√† c·∫≠p nh·∫≠t l·ªãch tr√¨nh ƒë∆∞a ƒë√≥n h·ªçc sinh</p>
    </div>
    <div>
      <button class="btn btn-outline" onclick="openDialog('updateDialog')">‚úèÔ∏è C·∫≠p nh·∫≠t l·ªãch tr√¨nh</button>
      <button class="btn btn-primary" onclick="openCreateDialog()">Ôºã T·∫°o l·ªãch tr√¨nh</button>
    </div>
  </div>

  <div class="week-nav">
    <button class="btn btn-outline" onclick="changeWeek(-1)">‚Üê Tu·∫ßn tr∆∞·ªõc</button>
    <div id="weekRange"></div>
    <button class="btn btn-outline" onclick="changeWeek(1)">Tu·∫ßn sau ‚Üí</button>
  </div>

  <div id="statusMessage" class="alert" style="display:none"></div>

  <div id="scheduleList"></div>

  <!-- Dialog t·∫°o l·ªãch -->
  <dialog id="createDialog">
    <h3>T·∫°o l·ªãch tr√¨nh m·ªõi</h3>
    <div id="createWeekInfo" class="week-info">üóìÔ∏è Tu·∫ßn ...</div>
    <div class="form-group">
      <label>Ng√†y trong tu·∫ßn</label>
      <div class="weekdays" id="daySelect">
        <div class="day">T2</div><div class="day">T3</div><div class="day">T4</div>
        <div class="day">T5</div><div class="day">T6</div><div class="day">T7</div><div class="day">CN</div>
      </div>
    </div>
    <div class="form-group">
      <label>Tuy·∫øn ƒë∆∞·ªùng</label>
      <select id="routeSelect">
        <option value="1">Tuy·∫øn 1</option>
        <option value="2">Tuy·∫øn 2</option>
        <option value="3">Tuy·∫øn 3</option>
      </select>
    </div>
    <div class="form-group">
      <label>Xe bu√Ωt</label>
      <select id="busSelect">
        <option value="101">Xe 101</option>
        <option value="102">Xe 102</option>
        <option value="103">Xe 103</option>
      </select>
    </div>
    <div class="form-group">
      <label>T√†i x·∫ø</label>
      <select id="driverSelect">
        <option value="1">Nguy·ªÖn VƒÉn A</option>
        <option value="2">Tr·∫ßn VƒÉn B</option>
        <option value="3">L√™ Th·ªã C</option>
      </select>
    </div>
    <div class="actions" style="text-align:right;">
      <button class="btn btn-outline" onclick="closeDialog('createDialog')">H·ªßy</button>
      <button class="btn btn-primary" onclick="confirmCreate()">T·∫°o</button>
    </div>
  </dialog>

  <!-- Dialog c·∫≠p nh·∫≠t -->
  <dialog id="updateDialog">
    <h3>C·∫≠p nh·∫≠t l·ªãch tr√¨nh</h3>
    <div id="updateWeekInfo" class="week-info">üóìÔ∏è Tu·∫ßn ...</div>
    <p>Ch·ªâ c√≥ th·ªÉ c·∫≠p nh·∫≠t tu·∫ßn hi·ªán t·∫°i ho·∫∑c tu·∫ßn s·∫Øp t·ªõi.</p>
    <div class="form-group">
      <label>Ch·ªçn tu·∫ßn ƒë·ªÉ c·∫≠p nh·∫≠t</label>
      <input type="week" id="updateWeekInput">
    </div>
    <div class="actions" style="text-align:right;">
      <button class="btn btn-outline" onclick="closeDialog('updateDialog')">H·ªßy</button>
      <button class="btn btn-primary" onclick="confirmUpdate()">C·∫≠p nh·∫≠t</button>
    </div>
  </dialog>
</div>

<script>
// D·ªØ li·ªáu m·∫´u
const sampleData = {
  // Tu·∫ßn tr∆∞·ªõc (ƒë√£ qua) - ch·ªâ xem
  '2023-W45': {
    'T2': { route: 'Tuy·∫øn 1', bus: 'Xe 101', driver: 'Nguy·ªÖn VƒÉn A' },
    'T3': { route: 'Tuy·∫øn 2', bus: 'Xe 102', driver: 'Tr·∫ßn VƒÉn B' },
    'T4': { route: 'Tuy·∫øn 1', bus: 'Xe 101', driver: 'Nguy·ªÖn VƒÉn A' },
    'T5': { route: 'Tuy·∫øn 3', bus: 'Xe 103', driver: 'L√™ Th·ªã C' },
    'T6': { route: 'Tuy·∫øn 2', bus: 'Xe 102', driver: 'Tr·∫ßn VƒÉn B' },
    'T7': { route: 'Tuy·∫øn 1', bus: 'Xe 101', driver: 'Nguy·ªÖn VƒÉn A' },
    'CN': { route: 'Kh√¥ng c√≥ l·ªãch', bus: '', driver: '' }
  },
  // Tu·∫ßn hi·ªán t·∫°i - ch·ªâ c√≥ th·ªÉ ch·ªânh s·ª≠a
  '2023-W46': {
    'T2': { route: 'Tuy·∫øn 2', bus: 'Xe 102', driver: 'Tr·∫ßn VƒÉn B' },
    'T3': { route: 'Tuy·∫øn 1', bus: 'Xe 101', driver: 'Nguy·ªÖn VƒÉn A' },
    'T4': { route: 'Tuy·∫øn 3', bus: 'Xe 103', driver: 'L√™ Th·ªã C' },
    'T5': { route: 'Tuy·∫øn 2', bus: 'Xe 102', driver: 'Tr·∫ßn VƒÉn B' },
    'T6': { route: 'Tuy·∫øn 1', bus: 'Xe 101', driver: 'Nguy·ªÖn VƒÉn A' },
    'T7': { route: 'Tuy·∫øn 3', bus: 'Xe 103', driver: 'L√™ Th·ªã C' },
    'CN': { route: 'Kh√¥ng c√≥ l·ªãch', bus: '', driver: '' }
  },
  // Tu·∫ßn sau - c√≥ th·ªÉ t·∫°o v√† ch·ªânh s·ª≠a
  '2023-W47': {
    'T2': { route: 'Tuy·∫øn 1', bus: 'Xe 101', driver: 'Nguy·ªÖn VƒÉn A' }
  }
};

const scheduleList = document.getElementById("scheduleList");
const weekRange = document.getElementById("weekRange");
const alertBox = document.getElementById("statusMessage");
let currentWeekStart = startOfWeek(new Date());

function startOfWeek(d) {
  const date = new Date(d);
  const day = date.getDay();
  const diff = date.getDate() - day + (day === 0 ? -6 : 1);
  return new Date(date.setDate(diff));
}

function formatDate(d) {
  return d.toLocaleDateString("vi-VN", { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function addDays(d, n) {
  const r = new Date(d);
  r.setDate(r.getDate() + n);
  return r;
}

function getWeekNumber(d) {
  const oneJan = new Date(d.getFullYear(), 0, 1);
  const days = Math.floor((d - oneJan) / (24 * 60 * 60 * 1000));
  return Math.ceil((days + oneJan.getDay() + 1) / 7);
}

function getWeekKey(date) {
  const year = date.getFullYear();
  const week = getWeekNumber(date);
  return `${year}-W${week.toString().padStart(2, '0')}`;
}

function loadWeek() {
  const start = startOfWeek(currentWeekStart);
  const end = addDays(start, 6);
  const weekNum = getWeekNumber(start);
  const weekKey = getWeekKey(start);
  
  weekRange.textContent = `üóìÔ∏è Tu·∫ßn ${weekNum}: ${formatDate(start)} - ${formatDate(end)}`;
  
  const now = new Date();
  const nowWeek = getWeekNumber(now);
  const nowWeekKey = getWeekKey(now);

  // X√°c ƒë·ªãnh tr·∫°ng th√°i tu·∫ßn
  if (weekNum < nowWeek) {
    showAlert("‚ùå Tu·∫ßn ƒë√£ ho√†n th√†nh ‚Äî ch·ªâ ƒë∆∞·ª£c xem, kh√¥ng th·ªÉ t·∫°o ho·∫∑c c·∫≠p nh·∫≠t.");
    disableButtons(true, true);
  } else if (weekNum === nowWeek) {
    showAlert("‚úèÔ∏è Tu·∫ßn hi·ªán t·∫°i ‚Äî ch·ªâ ƒë∆∞·ª£c ph√©p ch·ªânh s·ª≠a l·ªãch tr√¨nh hi·ªán c√≥.");
    disableButtons(true, false);
  } else {
    showAlert("‚úÖ Tu·∫ßn s·∫Øp t·ªõi ‚Äî c√≥ th·ªÉ t·∫°o m·ªõi v√† ch·ªânh s·ª≠a l·ªãch tr√¨nh.");
    disableButtons(false, false);
  }

  // Hi·ªÉn th·ªã l·ªãch tr√¨nh
  scheduleList.innerHTML = "";
  const weekSchedule = sampleData[weekKey] || {};
  
  for (let i = 0; i < 7; i++) {
    const d = addDays(start, i);
    const dayKey = ["T2", "T3", "T4", "T5", "T6", "T7", "CN"][i];
    const schedule = weekSchedule[dayKey];
    
    const card = document.createElement("div");
    card.className = "card";
    
    if (schedule) {
      // C√≥ l·ªãch tr√¨nh
      card.innerHTML = `
        <h3>${dayKey} - ${formatDate(d)}</h3>
        <div class="schedule-item">
          <div class="schedule-info">
            <strong>Tuy·∫øn ƒë∆∞·ªùng:</strong> ${schedule.route}<br>
            <strong>Xe bu√Ωt:</strong> ${schedule.bus}<br>
            <strong>T√†i x·∫ø:</strong> ${schedule.driver}
          </div>
          <div class="schedule-actions">
            ${weekNum >= nowWeek ? `<button class="btn btn-sm btn-primary" onclick="editSchedule('${weekKey}', '${dayKey}')">S·ª≠a</button>` : ''}
            ${weekNum > nowWeek ? `<button class="btn btn-sm btn-danger" onclick="deleteSchedule('${weekKey}', '${dayKey}')">X√≥a</button>` : ''}
          </div>
        </div>
      `;
    } else {
      // Ch∆∞a c√≥ l·ªãch tr√¨nh
      card.innerHTML = `
        <h3>${dayKey} - ${formatDate(d)}</h3>
        <div class="schedule-item">
          <div class="schedule-info">
            <small>Ch∆∞a c√≥ l·ªãch tr√¨nh</small>
          </div>
          <div class="schedule-actions">
            ${weekNum > nowWeek ? `<button class="btn btn-sm btn-success" onclick="addSchedule('${weekKey}', '${dayKey}')">Th√™m</button>` : ''}
          </div>
        </div>
      `;
    }
    
    scheduleList.appendChild(card);
  }
}

function showAlert(msg) {
  alertBox.style.display = 'block';
  alertBox.textContent = msg;
}

function disableButtons(disableCreate, disableUpdate) {
  document.querySelector('[onclick="openCreateDialog()"]').disabled = disableCreate;
  document.querySelector('[onclick="openDialog(\'updateDialog\')"]').disabled = disableUpdate;
}

function changeWeek(offset) {
  currentWeekStart = addDays(currentWeekStart, offset * 7);
  loadWeek();
}

// Qu·∫£n l√Ω l·ªãch tr√¨nh
function addSchedule(weekKey, dayKey) {
  // Trong th·ª±c t·∫ø, ƒë√¢y s·∫Ω l√† n∆°i m·ªü form th√™m l·ªãch tr√¨nh
  alert(`Th√™m l·ªãch tr√¨nh cho ${dayKey} c·ªßa tu·∫ßn ${weekKey}`);
  
  // T·∫°o d·ªØ li·ªáu m·∫´u
  if (!sampleData[weekKey]) sampleData[weekKey] = {};
  sampleData[weekKey][dayKey] = {
    route: 'Tuy·∫øn 1',
    bus: 'Xe 101',
    driver: 'Nguy·ªÖn VƒÉn A'
  };
  
  loadWeek();
}

function editSchedule(weekKey, dayKey) {
  // Trong th·ª±c t·∫ø, ƒë√¢y s·∫Ω l√† n∆°i m·ªü form ch·ªânh s·ª≠a
  alert(`Ch·ªânh s·ª≠a l·ªãch tr√¨nh cho ${dayKey} c·ªßa tu·∫ßn ${weekKey}`);
  
  // C·∫≠p nh·∫≠t d·ªØ li·ªáu m·∫´u
  sampleData[weekKey][dayKey] = {
    route: 'Tuy·∫øn 2',
    bus: 'Xe 102',
    driver: 'Tr·∫ßn VƒÉn B'
  };
  
  loadWeek();
}

function deleteSchedule(weekKey, dayKey) {
  if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch tr√¨nh c·ªßa ${dayKey}?`)) {
    delete sampleData[weekKey][dayKey];
    loadWeek();
  }
}

// Dialogs
function openDialog(id) {
  document.getElementById(id).showModal();
}

function closeDialog(id) {
  document.getElementById(id).close();
}

function openCreateDialog() {
  const start = startOfWeek(currentWeekStart);
  const end = addDays(start, 6);
  const weekNum = getWeekNumber(start);
  const nowWeek = getWeekNumber(new Date());
  
  // Ki·ªÉm tra n·∫øu l√† tu·∫ßn hi·ªán t·∫°i th√¨ kh√¥ng cho t·∫°o m·ªõi
  if (weekNum === nowWeek) {
    alert("Tu·∫ßn hi·ªán t·∫°i ch·ªâ ƒë∆∞·ª£c ch·ªânh s·ª≠a l·ªãch tr√¨nh hi·ªán c√≥, kh√¥ng th·ªÉ t·∫°o m·ªõi!");
    return;
  }
  
  document.getElementById("createWeekInfo").textContent = `üóìÔ∏è T·∫°o cho tu·∫ßn ${weekNum}: ${formatDate(start)} ‚Üí ${formatDate(end)}`;
  document.getElementById("createDialog").showModal();
}

function confirmCreate() {
  const selectedDays = Array.from(document.querySelectorAll("#daySelect .day.selected"))
    .map(day => day.textContent);
  
  if (selectedDays.length === 0) {
    alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ng√†y trong tu·∫ßn!");
    return;
  }
  
  const route = document.getElementById("routeSelect").value;
  const bus = document.getElementById("busSelect").value;
  const driver = document.getElementById("driverSelect").value;
  
  const weekKey = getWeekKey(currentWeekStart);
  
  // T·∫°o l·ªãch tr√¨nh cho c√°c ng√†y ƒë√£ ch·ªçn
  selectedDays.forEach(day => {
    if (!sampleData[weekKey]) sampleData[weekKey] = {};
    sampleData[weekKey][day] = {
      route: document.querySelector(`#routeSelect option[value="${route}"]`).textContent,
      bus: document.querySelector(`#busSelect option[value="${bus}"]`).textContent,
      driver: document.querySelector(`#driverSelect option[value="${driver}"]`).textContent
    };
  });
  
  alert("‚úÖ ƒê√£ t·∫°o l·ªãch tr√¨nh cho tu·∫ßn ƒë∆∞·ª£c ch·ªçn!");
  closeDialog('createDialog');
  loadWeek();
}

function confirmUpdate() {
  const week = document.getElementById("updateWeekInput").value;
  if (!week) {
    alert("Vui l√≤ng ch·ªçn tu·∫ßn c·∫ßn c·∫≠p nh·∫≠t!");
    return;
  }
  alert("‚úèÔ∏è ƒê√£ c·∫≠p nh·∫≠t l·ªãch tr√¨nh c·ªßa " + week);
  closeDialog('updateDialog');
}

// Ch·ªçn ng√†y
document.querySelectorAll("#daySelect .day").forEach(d => d.onclick = () => d.classList.toggle("selected"));

// Kh·ªüi t·∫°o
loadWeek();
</script>
</body>
</html>